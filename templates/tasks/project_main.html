{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>My Projects</h2>

  <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ -->
  <button id="add-project-btn" class="btn btn-outline-primary mb-3">+ New Project</button>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
  <div id="project-container">
    {% for project in projects %}
      <div class="card mb-2">
        <div class="card-body">
          <h5 class="card-title">{{ project.name }}</h5>
          <p class="card-text">{{ project.description }}</p>
          <small class="text-muted">Created at: {{ project.created_at|date:"Y-m-d H:i" }}</small>
        </div>
      </div>
    {% empty %}
      <p>No projects yet.</p>
    {% endfor %}
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="projectModalLabel">Add Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø³ÙŠÙØ­Ù…Ù‘Ù„ Ø¹Ø¨Ø± AJAX -->
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
// ðŸ” CSRF helper
function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith(name + '=')) {
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }
  return '';
}

// ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹
document.getElementById('add-project-btn').addEventListener('click', function () {
  fetch('/tasks/ajax/project/create/')
    .then(res => res.json())
    .then(data => {
      document.getElementById('modal-body').innerHTML = data.html;
      new bootstrap.Modal(document.getElementById('projectModal')).show();
    });
});


// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.addEventListener('submit', function (e) {
  if (e.target && e.target.id === 'project-form') {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch('/tasks/ajax/project/create/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
        location.reload(); 
      } else {
        document.getElementById('modal-body').innerHTML = data.html;
      }
    });
  }
});
</script>
{% endblock %}
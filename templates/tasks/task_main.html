{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>My Tasks</h2>

  <!-- search -->
  <input type="text" id="search-input" class="form-control mb-3" placeholder="Search tasks..." />

  <!-- add task -->
  <button class="btn btn-primary mb-3" id="add-task-btn" data-title="Create Task">Add Task</button>
  <!-- add Project -->
  <button class="btn btn-primary mb-3" id="add-project-btn" data-title="Create Project">+ New Project</button>
  <button id="sendTodayBtn" class="btn btn-primary mb-3">Submit today's tasks</button>
  <div id="todayStatus"></div>
  <h3>ðŸ“§ Submit a summary of tasks by time range</h3>
  <form id="sendTasksForm" style="margin-bottom: 20px;">
    <label for="start">from:</label>
    <input type="datetime-local" name="start" required>
    <label for="end">to:</label>
    <input type="datetime-local" name="end" required>
    <button type="submit">Send email</button>
  </form>
  <div id="emailStatus" style="margin-top: 10px; font-weight: bold;"></div>

  <!-- tasks list -->
  <div id="task-container">
    {% include 'tasks/partials/task_list.html' %}
  </div>
</div>

<!-- Form Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskModalLabel">Task Form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- form will uploaded by AJAX -->
      </div>
    </div>
  </div>
</div>
<script>
// ðŸ” Get CSRF token from cookie
function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith(name + '=')) {
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }
  return '';
}

document.addEventListener('DOMContentLoaded', function () {

  // ðŸ” Live search
  document.getElementById('search-input').addEventListener('keyup', function () {
    const query = this.value.trim();

    fetch(`/tasks/ajax/search/?q=${query}`)
      .then(res => res.text())
      .then(data => {
        document.getElementById('task-container').innerHTML = data;
      });
  });

  // âž• Open ADD TASK modal
  document.getElementById('add-task-btn').addEventListener('click', function () {
    const title=this.dataset.title;
    fetch('/tasks/ajax/create/')
      .then(res => res.text())
      .then(formHtml => {
        document.getElementById('modal-body').innerHTML = formHtml;
        document.querySelector('#taskModal .modal-title').innerText = title;
        new bootstrap.Modal(document.getElementById('taskModal')).show();
      });
  });


  // ðŸ“ Create OR Update (Submit form)
  document.addEventListener('submit', function (e) {
    if (e.target && e.target.id === 'task-form') {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const taskId = form.dataset.id || ''; // update OR create
      const url = taskId ? `/tasks/ajax/update/${taskId}/` : '/tasks/ajax/create/';

      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(res => res.json())
        .then(data => {

          if (data.success) {
            // Reload task list
            fetch('/tasks/ajax/list/')
              .then(res => res.text())
              .then(listHtml => {
                document.getElementById('task-container').innerHTML = listHtml;
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
              });

          } else {
            // Reload the form with validation errors
            fetch(url)
              .then(res => res.text())
              .then(formHtml => {
                document.getElementById('modal-body').innerHTML = formHtml;
              });
          }

        })
        .catch(err => console.error('Error:', err));
    }
  });



  // âœï¸ Open EDIT modal
  document.addEventListener('click', function (e) {
    if (e.target && e.target.classList.contains('edit-task-btn')) {
      const taskId = e.target.dataset.id;
      const title=e.target.dataset.title;
      fetch(`/tasks/ajax/update/${taskId}/`)
        .then(res => res.text())
        .then(formHtml => {
          document.getElementById('modal-body').innerHTML = formHtml;
          document.querySelector('#taskModal .modal-title').innerText = title;
          new bootstrap.Modal(document.getElementById('taskModal')).show();
        });
    }
  });



  // ðŸ—‘ Delete task
  document.addEventListener('click', function (e) {
    if (e.target && e.target.classList.contains('delete-task')) {
      const taskId = e.target.dataset.id;

      if (!confirm('Are you sure you want to delete this task?')) return;

      fetch(`/tasks/ajax/delete/${taskId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            fetch('/tasks/ajax/list/')
              .then(res => res.text())
              .then(listHtml => {
                document.getElementById('task-container').innerHTML = listHtml;
              });
          }
        })
        .catch(err => console.error('Error:', err));
    }
  });



  // ðŸ” Toggle Status (DONE / TODO / IN PROGRESS)
  document.addEventListener('click', function (e) {
    if (e.target && e.target.classList.contains('toggle-status')) {
      const taskId = e.target.dataset.id;

      fetch(`/tasks/ajax/toggle-status/${taskId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            fetch('/tasks/ajax/list/')
              .then(res => res.text())
              .then(listHtml => {
                document.getElementById('task-container').innerHTML = listHtml;
              });
          }
        })
        .catch(err => console.error('Error:', err));
    }
  });

  //Open Project Model and add project
  document.getElementById('add-project-btn').addEventListener('click', function () {
  const title=this.dataset.title;
  fetch('/tasks/ajax/project/create/')
    .then(res => res.json())
    .then(data => {
      document.getElementById('modal-body').innerHTML = data.html;
      document.querySelector('#taskModal .modal-title').innerText = title;
      new bootstrap.Modal(document.getElementById('taskModal')).show();
    });
});

document.addEventListener('submit', function (e) {
  if (e.target && e.target.id === 'project-form') {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch('/tasks/ajax/project/create/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
      } else {
        document.getElementById('modal-body').innerHTML = data.html;
      }
    });
  }
});
});

//send-tasks-by-range 
document.getElementById('sendTasksForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch('/tasks/api/send-tasks-by-range/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const statusDiv = document.getElementById('emailStatus');
    statusDiv.textContent = data.message;
    statusDiv.style.color = data.success ? 'green' : 'red';
  });
});

//send-today-tasks
document.getElementById('sendTodayBtn').addEventListener('click', function() {
  fetch('/tasks/api/send-today-tasks/')
    .then(res => res.json())
    .then(data => {
      const statusDiv = document.getElementById('todayStatus');
      statusDiv.textContent = data.message;
      statusDiv.style.color = data.success ? 'green' : 'red';
    });
});

</script>

{% endblock %}